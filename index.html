<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTA-FE & TEA - H·ªá Th·ªëng Ch·∫•m C√¥ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-small {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen bg-gradient-to-br from-blue-50 to-white flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">ƒêang k·∫øt n·ªëi cloud database...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-blue-50 to-white flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md border border-blue-100">
            <div class="text-center mb-8">
                <div class="bg-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="text-white w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">VTA-FE & TEA</h1>
                <p class="text-gray-600">H·ªá Th·ªëng Ch·∫•m C√¥ng</p>
                
                <div id="loginSyncStatus" class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-green-100 text-green-700">
                    <span>‚òÅÔ∏è ƒê√£ k·∫øt n·ªëi</span>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input
                        type="text"
                        id="username"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                        placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                        autocomplete="username"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                    <input
                        type="password"
                        id="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                        autocomplete="current-password"
                    />
                </div>
                
                <button
                    id="loginButton"
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2"
                >
                    ƒêƒÉng Nh·∫≠p
                </button>
                
                <div class="text-sm text-gray-500 text-center mt-4">
                    <p><strong>‚òÅÔ∏è Cloud Database:</strong></p>
                    <p>Admin: admin / admin</p>
                    <p>NV: nhanvien1 / 123</p>
                    <p class="mt-2 text-xs text-blue-600">üåç T·∫•t c·∫£ thi·∫øt b·ªã trong qu√°n ƒë·ªÅu th·∫•y d·ªØ li·ªáu</p>
                    <p class="text-xs text-green-600">‚ö° ƒê·ªìng b·ªô th·ªùi gian th·ª±c</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="min-h-screen bg-gradient-to-br from-blue-50 to-white hidden">
        <!-- Header -->
        <div class="bg-white shadow-lg border-b border-blue-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500 w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="text-white w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">VTA-FE & TEA</h1>
                            <p class="text-sm text-gray-600">H·ªá Th·ªëng Ch·∫•m C√¥ng</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div id="mainSyncStatus" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-700">
                            <span>‚òÅÔ∏è ƒêang ƒë·ªìng b·ªô</span>
                        </div>
                        
                        <div class="text-right">
                            <p class="font-medium text-gray-800" id="currentUserName">Ng∆∞·ªùi d√πng</p>
                            <p class="text-sm text-blue-600 capitalize" id="currentUserRole">employee</p>
                        </div>
                        <button
                            id="logoutButton"
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2"
                        >
                            ƒêƒÉng Xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Time Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-blue-100">
                <div class="text-center">
                    <div class="text-4xl font-bold text-blue-600 mb-2" id="currentTime">
                        00:00:00
                    </div>
                    <div class="text-lg text-gray-600" id="currentDate">
                        H√¥m nay
                    </div>
                </div>
            </div>

            <!-- Employee Dashboard -->
            <div id="employeeDashboard" class="space-y-8 hidden">
                <!-- Salary Summary Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd" />
                        </svg>
                        T·ªïng L∆∞∆°ng Th√°ng <span id="currentMonthYear" class="text-blue-600"></span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">L∆∞∆°ng/Gi·ªù</p>
                            <p class="text-2xl font-bold text-blue-600" id="hourlyRateDisplay">0 ‚Ç´</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">T·ªïng Gi·ªù L√†m</p>
                            <p class="text-2xl font-bold text-green-600" id="totalHoursDisplay">0h</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">T·ªïng L∆∞∆°ng</p>
                            <p class="text-2xl font-bold text-yellow-600" id="totalSalaryDisplay">0 ‚Ç´</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">
                            üí° <strong>H·ªá th·ªëng ca l√†m vi·ªác:</strong> M·ªói l·∫ßn "V√†o Ca M·ªõi" t·∫°o m·ªôt ca ri√™ng bi·ªát. Admin c√≥ th·ªÉ ch·ªânh s·ª≠a gi·ªù l√†m t·ª´ng ca.
                        </p>
                        <p class="text-xs text-blue-600 mt-2">
                            ‚òÅÔ∏è D·ªØ li·ªáu t·ª± ƒë·ªông ƒë·ªìng b·ªô cloud - t·∫•t c·∫£ thi·∫øt b·ªã trong qu√°n ƒë·ªÅu th·∫•y c·∫≠p nh·∫≠t th·ªùi gian th·ª±c!
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Attendance Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            Ch·∫•m C√¥ng
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div id="workingStatus" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
                                    Ch∆∞a ch·∫•m c√¥ng
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <button
                                    id="checkinButton"
                                    class="w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-green-500 text-white hover:bg-green-600"
                                >
                                    V√†o Ca M·ªõi
                                </button>
                                
                                <button
                                    id="checkoutButton"
                                    class="w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-red-500 text-white hover:bg-red-600"
                                    disabled
                                >
                                    K·∫øt Th√∫c Ca
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- History Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd" />
                            </svg>
                            L·ªãch S·ª≠ L√†m Vi·ªác
                        </h2>
                        
                        <div class="mb-4 flex gap-2">
                            <select
                                id="monthSelect"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            >
                                <option value="1">Th√°ng 1</option>
                                <option value="2">Th√°ng 2</option>
                                <option value="3">Th√°ng 3</option>
                                <option value="4">Th√°ng 4</option>
                                <option value="5">Th√°ng 5</option>
                                <option value="6">Th√°ng 6</option>
                                <option value="7">Th√°ng 7</option>
                                <option value="8">Th√°ng 8</option>
                                <option value="9">Th√°ng 9</option>
                                <option value="10">Th√°ng 10</option>
                                <option value="11">Th√°ng 11</option>
                                <option value="12">Th√°ng 12</option>
                            </select>
                            
                            <select
                                id="yearSelect"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            >
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>

                        <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                ƒêang t·∫£i d·ªØ li·ªáu...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="space-y-8 hidden">
                <!-- Controls -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                </svg>
                                Qu·∫£n L√Ω Nh√¢n Vi√™n
                            </h2>
                            
                            <div class="flex gap-2">
                                <select
                                    id="adminMonthSelect"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                >
                                    <option value="1">Th√°ng 1</option>
                                    <option value="2">Th√°ng 2</option>
                                    <option value="3">Th√°ng 3</option>
                                    <option value="4">Th√°ng 4</option>
                                    <option value="5">Th√°ng 5</option>
                                    <option value="6">Th√°ng 6</option>
                                    <option value="7">Th√°ng 7</option>
                                    <option value="8">Th√°ng 8</option>
                                    <option value="9">Th√°ng 9</option>
                                    <option value="10">Th√°ng 10</option>
                                    <option value="11">Th√°ng 11</option>
                                    <option value="12">Th√°ng 12</option>
                                </select>
                                
                                <select
                                    id="adminYearSelect"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                >
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button
                                id="exportButton"
                                class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors"
                            >
                                Xu·∫•t Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Employee Table -->
                <div class="bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Nh√¢n Vi√™n</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">L∆∞∆°ng/Gi·ªù</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Gi·ªù L√†m/Th√°ng</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">L∆∞∆°ng Th·ª±c Nh·∫≠n</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800" id="modalEmployeeName">Chi Ti·∫øt Ch·∫•m C√¥ng</h3>
                    <button onclick="closeEmployeeDetail()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4 flex gap-4 items-center">
                    <h4 class="text-lg font-medium text-gray-800">Th√°ng:</h4>
                    <select id="modalMonthSelect" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="1">Th√°ng 1</option>
                        <option value="2">Th√°ng 2</option>
                        <option value="3">Th√°ng 3</option>
                        <option value="4">Th√°ng 4</option>
                        <option value="5">Th√°ng 5</option>
                        <option value="6">Th√°ng 6</option>
                        <option value="7">Th√°ng 7</option>
                        <option value="8">Th√°ng 8</option>
                        <option value="9">Th√°ng 9</option>
                        <option value="10">Th√°ng 10</option>
                        <option value="11">Th√°ng 11</option>
                        <option value="12">Th√°ng 12</option>
                    </select>
                    <select id="modalYearSelect" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                    <button onclick="loadEmployeeDetail()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        T·∫£i D·ªØ Li·ªáu
                    </button>
                </div>

                <div id="employeeDetailContent" class="space-y-4">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // ‚ö†Ô∏è THAY ƒê·ªîI CONFIG N√ÄY ƒê·ªÇ K·∫æT N·ªêI DATABASE TH·∫¨T
        // ================================
        
        // üî• B∆Ø·ªöC 1: T·∫°o t√†i kho·∫£n Supabase t·∫°i https://supabase.com
        // üî• B∆Ø·ªöC 2: T·∫°o project m·ªõi
        // üî• B∆Ø·ªöC 3: Copy URL v√† API Key v√†o ƒë√¢y
        
        const SUPABASE_URL = 'https://your-project.supabase.co'; // ‚Üê Thay b·∫±ng URL th·ª±c c·ªßa b·∫°n
        const SUPABASE_KEY = 'your-anon-public-key'; // ‚Üê Thay b·∫±ng API key th·ª±c c·ªßa b·∫°n
        
        // üî• B∆Ø·ªöC 4: V√†o Supabase SQL Editor v√† ch·∫°y script t·∫°o b·∫£ng (xem h∆∞·ªõng d·∫´n cu·ªëi file)
        
        // ================================
        // MAIN APPLICATION CODE
        // ================================

        // Global variables
        let currentUser = null;
        let employees = [];
        let attendanceRecords = [];
        let isWorking = false;
        let syncStatus = 'synced';
        let selectedMonth = new Date().getMonth() + 1;
        let selectedYear = new Date().getFullYear();
        let editingEmployee = null;
        let currentDetailEmployeeId = null;
        let eventListenersAdded = false;
        let syncInterval = null;

        // Cloud Database API
        const cloudAPI = {
            // Check if database is configured
            isConfigured() {
                return SUPABASE_URL !== 'https://your-project.supabase.co' && 
                       SUPABASE_KEY !== 'your-anon-public-key';
            },

            // Make API calls to Supabase
            async apiCall(endpoint, method = 'GET', data = null) {
                if (!this.isConfigured()) {
                    // Fallback to demo data if not configured
                    return this.getDemoData(endpoint, method, data);
                }

                const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                
                try {
                    const config = {
                        method,
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': method === 'POST' ? 'return=representation' : undefined
                        }
                    };

                    if (data && method !== 'GET') {
                        config.body = JSON.stringify(data);
                    }

                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = method === 'DELETE' ? null : await response.json();
                    
                    return { 
                        success: true, 
                        data: result 
                    };
                    
                } catch (error) {
                    console.error('API Error:', error);
                    return { 
                        success: false, 
                        error: error.message 
                    };
                }
            },

            // Demo data fallback (when database not configured)
            demoData: {
                employees: [
                    { id: 1, name: 'Nguy·ªÖn VƒÉn A', username: 'admin', password: 'admin', role: 'admin', hourly_rate: 100000 },
                    { id: 2, name: 'Tr·∫ßn Th·ªã B', username: 'nhanvien1', password: '123', role: 'employee', hourly_rate: 50000 },
                    { id: 3, name: 'L√™ VƒÉn C', username: 'nhanvien2', password: '123', role: 'employee', hourly_rate: 45000 }
                ],
                attendanceRecords: []
            },

            getDemoData(endpoint, method, data) {
                // Simulate network delay
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (endpoint === 'employees' && method === 'GET') {
                            resolve({ success: true, data: this.demoData.employees });
                        } else if (endpoint === 'attendance_records' && method === 'GET') {
                            resolve({ success: true, data: this.demoData.attendanceRecords });
                        } else if (endpoint === 'attendance_records' && method === 'POST') {
                            const newRecord = { ...data, id: Date.now() + Math.random() };
                            this.demoData.attendanceRecords.push(newRecord);
                            resolve({ success: true, data: newRecord });
                        } else if (endpoint.startsWith('attendance_records?id=eq.') && method === 'PATCH') {
                            const id = parseFloat(endpoint.split('=')[1]);
                            const index = this.demoData.attendanceRecords.findIndex(r => r.id === id);
                            if (index !== -1) {
                                this.demoData.attendanceRecords[index] = { ...this.demoData.attendanceRecords[index], ...data };
                                resolve({ success: true, data: this.demoData.attendanceRecords[index] });
                            } else {
                                resolve({ success: false });
                            }
                        } else if (endpoint.startsWith('attendance_records?id=eq.') && method === 'DELETE') {
                            const id = parseFloat(endpoint.split('=')[1]);
                            this.demoData.attendanceRecords = this.demoData.attendanceRecords.filter(r => r.id !== id);
                            resolve({ success: true });
                        } else if (endpoint.startsWith('employees?id=eq.') && method === 'PATCH') {
                            const id = parseInt(endpoint.split('=')[1]);
                            const index = this.demoData.employees.findIndex(e => e.id === id);
                            if (index !== -1) {
                                this.demoData.employees[index] = { ...this.demoData.employees[index], ...data };
                                resolve({ success: true, data: this.demoData.employees[index] });
                            } else {
                                resolve({ success: false });
                            }
                        } else {
                            resolve({ success: false, error: 'Endpoint not found' });
                        }
                    }, 300);
                });
            },

            // API Methods
            async getEmployees() {
                return await this.apiCall('employees');
            },

            async getAttendanceRecords() {
                return await this.apiCall('attendance_records');
            },

            async updateEmployee(id, data) {
                return await this.apiCall(`employees?id=eq.${id}`, 'PATCH', data);
            },

            async addAttendanceRecord(record) {
                return await this.apiCall('attendance_records', 'POST', record);
            },

            async updateAttendanceRecord(id, data) {
                return await this.apiCall(`attendance_records?id=eq.${id}`, 'PATCH', data);
            },

            async deleteAttendanceRecord(id) {
                return await this.apiCall(`attendance_records?id=eq.${id}`, 'DELETE');
            },

            // Real-time sync
            startRealTimeSync() {
                if (syncInterval) clearInterval(syncInterval);
                
                syncInterval = setInterval(async () => {
                    if (currentUser && syncStatus !== 'syncing') {
                        try {
                            const [employeesResponse, recordsResponse] = await Promise.all([
                                this.getEmployees(),
                                this.getAttendanceRecords()
                            ]);

                            if (employeesResponse.success && recordsResponse.success) {
                                // Update global data
                                employees = employeesResponse.data;
                                attendanceRecords = recordsResponse.data;

                                // Update UI
                                if (currentUser.role === 'employee') {
                                    updateEmployeeStatus();
                                    renderHistory();
                                    updateEmployeeSalaryInfo();
                                } else if (currentUser.role === 'admin') {
                                    renderEmployeeTable();
                                }

                                updateSyncStatus('synced');
                            }
                        } catch (error) {
                            console.error('Real-time sync failed:', error);
                            updateSyncStatus('error');
                            setTimeout(() => updateSyncStatus('synced'), 3000);
                        }
                    }
                }, 10000); // Sync every 10 seconds
            },

            stopRealTimeSync() {
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
            }
        };

        // Helper functions
        function updateSyncStatus(status) {
            syncStatus = status;
            const statusElements = ['loginSyncStatus', 'mainSyncStatus'];
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    let className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm ';
                    let content = '';
                    
                    if (status === 'synced') {
                        className += 'bg-green-100 text-green-700';
                        content = cloudAPI.isConfigured() ? 
                            '<span>‚òÅÔ∏è ƒê·ªìng b·ªô cloud</span>' : 
                            '<span>üî∂ Demo mode</span>';
                    } else if (status === 'syncing') {
                        className += 'bg-yellow-100 text-yellow-700';
                        content = '<div class="spinner-small"></div><span>ƒêang ƒë·ªìng b·ªô...</span>';
                    } else if (status === 'error') {
                        className += 'bg-red-100 text-red-700';
                        content = '<span>‚ùå L·ªói k·∫øt n·ªëi</span>';
                    }
                    
                    element.className = className;
                    element.innerHTML = content;
                }
            });
        }

        function updateTime() {
            const now = new Date();
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('vi-VN');
            }
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('vi-VN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function calculateWorkingHours(checkIn, checkOut) {
            if (!checkOut) return 0;
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            const hours = (end - start) / (1000 * 60 * 60);
            return hours;
        }

        function getMonthlyRecords(employeeId) {
            return attendanceRecords.filter(record => {
                const recordDate = new Date(record.check_in);
                return record.employee_id === employeeId && 
                       recordDate.getMonth() + 1 === selectedMonth && 
                       recordDate.getFullYear() === selectedYear;
            });
        }

        function calculateMonthlySalary(employee) {
            const monthlyRecords = getMonthlyRecords(employee.id);
            const totalHours = monthlyRecords.reduce((total, record) => {
                return total + calculateWorkingHours(record.check_in, record.check_out);
            }, 0);
            return Math.round(totalHours * employee.hourly_rate);
        }

        function updateEmployeeSalaryInfo() {
            if (currentUser && currentUser.role === 'employee') {
                const monthlyRecords = getMonthlyRecords(currentUser.id);
                const totalHours = monthlyRecords.reduce((total, record) => {
                    return total + calculateWorkingHours(record.check_in, record.check_out);
                }, 0);
                const totalSalary = totalHours * currentUser.hourly_rate;
                
                const monthYearEl = document.getElementById('currentMonthYear');
                const hourlyRateEl = document.getElementById('hourlyRateDisplay');
                const totalHoursEl = document.getElementById('totalHoursDisplay');
                const totalSalaryEl = document.getElementById('totalSalaryDisplay');
                
                if (monthYearEl) monthYearEl.textContent = `${selectedMonth}/${selectedYear}`;
                if (hourlyRateEl) hourlyRateEl.textContent = currentUser.hourly_rate.toLocaleString('vi-VN') + ' ‚Ç´';
                if (totalHoursEl) totalHoursEl.textContent = totalHours.toFixed(1) + 'h';
                if (totalSalaryEl) totalSalaryEl.textContent = Math.round(totalSalary).toLocaleString('vi-VN') + ' ‚Ç´';
            }
        }

        // Initialize app
        async function initializeApp() {
            try {
                updateSyncStatus('syncing');
                
                // Show configuration warning if not set up
                if (!cloudAPI.isConfigured()) {
                    console.warn('‚ö†Ô∏è Database ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. ƒêang ch·∫°y ·ªü demo mode.');
                }
                
                const [employeesResponse, recordsResponse] = await Promise.all([
                    cloudAPI.getEmployees(),
                    cloudAPI.getAttendanceRecords()
                ]);

                if (employeesResponse.success) {
                    employees = employeesResponse.data;
                }
                
                if (recordsResponse.success) {
                    attendanceRecords = recordsResponse.data;
                }

                updateSyncStatus('synced');
                showLoginScreen();
                
            } catch (error) {
                console.error('Failed to load data:', error);
                updateSyncStatus('error');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Add login event listeners
            const loginBtn = document.getElementById('loginButton');
            const passwordField = document.getElementById('password');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (passwordField) {
                passwordField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            // Set current month/year
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const adminMonthSelect = document.getElementById('adminMonthSelect');
            const adminYearSelect = document.getElementById('adminYearSelect');
            
            if (monthSelect) monthSelect.value = selectedMonth;
            if (yearSelect) yearSelect.value = selectedYear;
            if (adminMonthSelect) adminMonthSelect.value = selectedMonth;
            if (adminYearSelect) adminYearSelect.value = selectedYear;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            const userNameEl = document.getElementById('currentUserName');
            const userRoleEl = document.getElementById('currentUserRole');
            
            if (userNameEl) userNameEl.textContent = currentUser.name;
            if (userRoleEl) userRoleEl.textContent = currentUser.role;
            
            // Add event listeners
            if (!eventListenersAdded) {
                addEventListeners();
            }
            
            if (currentUser.role === 'employee') {
                document.getElementById('employeeDashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                updateEmployeeStatus();
                renderHistory();
                updateEmployeeSalaryInfo();
            } else {
                document.getElementById('employeeDashboard').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                renderEmployeeTable();
            }

            // Start real-time sync
            cloudAPI.startRealTimeSync();
        }

        function updateEmployeeStatus() {
            if (!currentUser || currentUser.role !== 'employee') return;
            
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                record.employee_id === currentUser.id && 
                new Date(record.check_in).toDateString() === today
            );
            
            const activeSession = todayRecords.find(record => !record.check_out);
            isWorking = !!activeSession;
            
            const statusElement = document.getElementById('workingStatus');
            const checkinButton = document.getElementById('checkinButton');
            const checkoutButton = document.getElementById('checkoutButton');
            
            if (!statusElement || !checkinButton || !checkoutButton) return;
            
            if (isWorking) {
                const startTime = new Date(activeSession.check_in).toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                statusElement.textContent = `ƒêang trong ca (b·∫Øt ƒë·∫ßu ${startTime})`;
                statusElement.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-700';
                
                checkinButton.disabled = true;
                checkinButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-gray-100 text-gray-400 cursor-not-allowed';
                checkinButton.textContent = 'ƒêang Trong Ca';
                
                checkoutButton.disabled = false;
                checkoutButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-red-500 text-white hover:bg-red-600';
                checkoutButton.textContent = 'K·∫øt Th√∫c Ca';
            } else {
                const completedSessions = todayRecords.filter(record => record.check_out).length;
                const totalHoursToday = todayRecords.reduce((total, record) => 
                    total + calculateWorkingHours(record.check_in, record.check_out), 0
                );
                
                if (completedSessions > 0) {
                    statusElement.textContent = `ƒê√£ ho√†n th√†nh ${completedSessions} ca (${totalHoursToday.toFixed(1)}h)`;
                } else {
                    statusElement.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu ca l√†m vi·ªác h√¥m nay';
                }
                statusElement.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-700';
                
                checkinButton.disabled = false;
                checkinButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-green-500 text-white hover:bg-green-600';
                checkinButton.textContent = completedSessions > 0 ? 'V√†o Ca M·ªõi' : 'B·∫Øt ƒê·∫ßu Ca';
                
                checkoutButton.disabled = true;
                checkoutButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-gray-100 text-gray-400 cursor-not-allowed';
                checkoutButton.textContent = 'K·∫øt Th√∫c Ca';
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            const records = getMonthlyRecords(currentUser.id);
            
            if (records.length === 0) {
                historyList.innerHTML = '<div class="text-center py-8 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng trong th√°ng n√†y</div>';
            } else {
                const recordsByDate = {};
                records.forEach(record => {
                    const dateKey = new Date(record.check_in).toDateString();
                    if (!recordsByDate[dateKey]) {
                        recordsByDate[dateKey] = [];
                    }
                    recordsByDate[dateKey].push(record);
                });

                historyList.innerHTML = Object.keys(recordsByDate).map(dateKey => {
                    const dayRecords = recordsByDate[dateKey];
                    const totalHours = dayRecords.reduce((total, record) => 
                        total + calculateWorkingHours(record.check_in, record.check_out), 0
                    );
                    const dailySalary = totalHours * currentUser.hourly_rate;

                    return `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-800">
                                    ${new Date(dateKey).toLocaleDateString('vi-VN')}
                                </span>
                                <div class="text-right">
                                    <div class="text-blue-600 font-medium">${totalHours.toFixed(1)}h</div>
                                    <div class="text-green-600 text-sm font-medium">${Math.round(dailySalary).toLocaleString('vi-VN')} ‚Ç´</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                ${dayRecords.map((record, index) => {
                                    const sessionHours = calculateWorkingHours(record.check_in, record.check_out);
                                    const sessionSalary = sessionHours * currentUser.hourly_rate;
                                    
                                    return `
                                        <div class="text-sm bg-white p-3 rounded border-l-4 ${record.check_out ? 'border-green-400' : 'border-yellow-400'}">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-medium text-gray-700">Ca ${index + 1}</span>
                                                ${record.check_out ? 
                                                    `<span class="text-green-600 font-medium">${sessionHours.toFixed(1)}h - ${Math.round(sessionSalary).toLocaleString('vi-VN')} ‚Ç´</span>` :
                                                    `<span class="text-yellow-600 font-medium">ƒêang trong ca</span>`
                                                }
                                            </div>
                                            <div class="text-gray-600">
                                                <span>B·∫Øt ƒë·∫ßu: ${new Date(record.check_in).toLocaleTimeString('vi-VN')}</span>
                                                ${record.check_out ? 
                                                    `<span class="ml-4">K·∫øt th√∫c: ${new Date(record.check_out).toLocaleTimeString('vi-VN')}</span>` : 
                                                    '<span class="ml-4 text-yellow-600">(Ch∆∞a k·∫øt th√∫c)</span>'
                                                }
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateEmployeeSalaryInfo();
        }

        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            if (!tbody) return;
            
            const employeeList = employees.filter(emp => emp.role === 'employee');
            
            tbody.innerHTML = employeeList.map(employee => {
                const monthlyHours = getMonthlyRecords(employee.id).reduce((total, record) => 
                    total + calculateWorkingHours(record.check_in, record.check_out), 0
                );
                
                const monthlySalary = calculateMonthlySalary(employee);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                                    <svg class="text-blue-600 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${employee.name}</p>
                                    <p class="text-sm text-gray-500">ID: ${employee.id}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${editingEmployee === employee.id ? 
                                `<div class="flex gap-2">
                                    <input
                                        type="number"
                                        value="${employee.hourly_rate}"
                                        class="w-32 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        onkeypress="handleSalaryEdit(event, ${employee.id})"
                                    />
                                    <button onclick="cancelEdit()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                                </div>` :
                                `<span class="text-gray-800 font-medium">${employee.hourly_rate.toLocaleString('vi-VN')} ‚Ç´/h</span>`
                            }
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-800">${monthlyHours.toFixed(1)}h</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-green-600 font-bold">${monthlySalary.toLocaleString('vi-VN')} ‚Ç´</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button
                                    onclick="editEmployee(${employee.id})"
                                    class="text-blue-500 hover:text-blue-700 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                                    title="Ch·ªânh s·ª≠a l∆∞∆°ng"
                                >
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button
                                    onclick="viewEmployeeDetails(${employee.id})"
                                    class="text-purple-500 hover:text-purple-700 p-2 hover:bg-purple-50 rounded-lg transition-colors"
                                    title="Xem chi ti·∫øt ch·∫•m c√¥ng"
                                >
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Event handlers
        async function handleLogin() {
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            
            if (!usernameField || !passwordField) return;
            
            const username = usernameField.value;
            const password = passwordField.value;
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                const user = employees.find(emp => 
                    emp.username === username && emp.password === password
                );
                
                if (user) {
                    currentUser = user;
                    usernameField.value = '';
                    passwordField.value = '';
                    updateSyncStatus('synced');
                    showMainApp();
                } else {
                    alert('Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng!');
                    updateSyncStatus('error');
                    setTimeout(() => updateSyncStatus('synced'), 2000);
                }
            } catch (error) {
                console.error('Login failed:', error);
                updateSyncStatus('error');
            }
        }

        function handleLogout() {
            currentUser = null;
            isWorking = false;
            editingEmployee = null;
            eventListenersAdded = false;
            cloudAPI.stopRealTimeSync();
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        async function handleCheckin() {
            if (syncStatus === 'syncing') return;
            if (!currentUser || currentUser.role !== 'employee') return;
            
            const checkinBtn = document.getElementById('checkinButton');
            if (checkinBtn && checkinBtn.disabled) return;
            
            try {
                updateSyncStatus('syncing');
                const now = new Date();
                
                const activeSession = attendanceRecords.find(record => 
                    record.employee_id === currentUser.id && !record.check_out
                );
                
                if (activeSession) {
                    alert('B·∫°n ƒëang trong ca l√†m vi·ªác! Vui l√≤ng k·∫øt th√∫c ca hi·ªán t·∫°i tr∆∞·ªõc.');
                    updateSyncStatus('synced');
                    return;
                }
                
                const newRecord = {
                    employee_id: currentUser.id,
                    employee_name: currentUser.name,
                    check_in: now.toISOString(),
                    check_out: null,
                    date: now.toISOString().split('T')[0]
                };
                
                const response = await cloudAPI.addAttendanceRecord(newRecord);
                
                if (response.success) {
                    attendanceRecords.push(response.data);
                    updateEmployeeStatus();
                    renderHistory();
                    updateSyncStatus('synced');
                } else {
                    updateSyncStatus('error');
                    alert('C√≥ l·ªói x·∫£y ra khi ch·∫•m c√¥ng!');
                }
            } catch (error) {
                console.error('Check-in failed:', error);
                updateSyncStatus('error');
            }
        }

        async function handleCheckout() {
            if (syncStatus === 'syncing') return;
            if (!currentUser || currentUser.role !== 'employee') return;
            
            const checkoutBtn = document.getElementById('checkoutButton');
            if (checkoutBtn && checkoutBtn.disabled) return;
            
            try {
                updateSyncStatus('syncing');
                const now = new Date();
                
                const recordToUpdate = attendanceRecords.find(record => 
                    record.employee_id === currentUser.id && !record.check_out
                );

                if (!recordToUpdate) {
                    alert('Kh√¥ng t√¨m th·∫•y ca l√†m vi·ªác ƒëang ho·∫°t ƒë·ªông!');
                    updateSyncStatus('synced');
                    return;
                }

                const response = await cloudAPI.updateAttendanceRecord(recordToUpdate.id, {
                    check_out: now.toISOString()
                });

                if (response.success) {
                    const index = attendanceRecords.findIndex(r => r.id === recordToUpdate.id);
                    if (index !== -1) {
                        attendanceRecords[index] = { ...attendanceRecords[index], check_out: now.toISOString() };
                    }
                    updateEmployeeStatus();
                    renderHistory();
                    updateSyncStatus('synced');
                } else {
                    updateSyncStatus('error');
                    alert('C√≥ l·ªói x·∫£y ra khi k·∫øt th√∫c ca!');
                }
            } catch (error) {
                console.error('Check-out failed:', error);
                updateSyncStatus('error');
            }
        }

        function editEmployee(employeeId) {
            if (editingEmployee === employeeId) {
                editingEmployee = null;
            } else {
                editingEmployee = employeeId;
            }
            renderEmployeeTable();
        }

        function cancelEdit() {
            editingEmployee = null;
            renderEmployeeTable();
        }

        async function handleSalaryEdit(event, employeeId) {
            if (event.key === 'Enter') {
                const newSalary = event.target.value;
                
                if (!newSalary || isNaN(newSalary)) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá!');
                    return;
                }

                try {
                    updateSyncStatus('syncing');
                    const response = await cloudAPI.updateEmployee(employeeId, { 
                        hourly_rate: parseFloat(newSalary) 
                    });
                    
                    if (response.success) {
                        const index = employees.findIndex(emp => emp.id === employeeId);
                        if (index !== -1) {
                            employees[index].hourly_rate = parseFloat(newSalary);
                        }
                        editingEmployee = null;
                        renderEmployeeTable();
                        updateSyncStatus('synced');
                    } else {
                        updateSyncStatus('error');
                        alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!');
                    }
                } catch (error) {
                    console.error('Update salary failed:', error);
                    updateSyncStatus('error');
                }
            }
        }

        function exportToExcel() {
            const data = employees.filter(emp => emp.role === 'employee').map(emp => {
                const monthlyHours = getMonthlyRecords(emp.id).reduce((total, record) => 
                    total + calculateWorkingHours(record.check_in, record.check_out), 0
                );
                const monthlySalary = calculateMonthlySalary(emp);
                
                return {
                    'H·ªç T√™n': emp.name,
                    'L∆∞∆°ng/Gi·ªù': emp.hourly_rate.toLocaleString('vi-VN'),
                    'Gi·ªù L√†m Th√°ng': monthlyHours.toFixed(1),
                    'L∆∞∆°ng Th·ª±c Nh·∫≠n': monthlySalary.toLocaleString('vi-VN')
                };
            });
            
            if (data.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }
            
            const csvContent = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bang-luong-${selectedMonth}-${selectedYear}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Employee Detail Modal
        function viewEmployeeDetails(employeeId) {
            currentDetailEmployeeId = employeeId;
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const modalTitle = document.getElementById('modalEmployeeName');
            const modalMonthSelect = document.getElementById('modalMonthSelect');
            const modalYearSelect = document.getElementById('modalYearSelect');
            const modal = document.getElementById('employeeDetailModal');
            
            if (modalTitle) modalTitle.textContent = `Chi Ti·∫øt Ch·∫•m C√¥ng - ${employee.name}`;
            if (modalMonthSelect) modalMonthSelect.value = selectedMonth;
            if (modalYearSelect) modalYearSelect.value = selectedYear;
            if (modal) modal.classList.remove('hidden');
            
            loadEmployeeDetail();
        }

        function closeEmployeeDetail() {
            const modal = document.getElementById('employeeDetailModal');
            if (modal) modal.classList.add('hidden');
            currentDetailEmployeeId = null;
        }

        function loadEmployeeDetail() {
            if (!currentDetailEmployeeId) return;
            
            const modalMonthSelect = document.getElementById('modalMonthSelect');
            const modalYearSelect = document.getElementById('modalYearSelect');
            
            const modalMonth = modalMonthSelect ? parseInt(modalMonthSelect.value) : selectedMonth;
            const modalYear = modalYearSelect ? parseInt(modalYearSelect.value) : selectedYear;
            const employee = employees.find(emp => emp.id === currentDetailEmployeeId);
            
            if (!employee) return;

            const employeeRecords = attendanceRecords.filter(record => {
                const recordDate = new Date(record.check_in);
                return record.employee_id === currentDetailEmployeeId && 
                       recordDate.getMonth() + 1 === modalMonth && 
                       recordDate.getFullYear() === modalYear;
            });

            const recordsByDate = {};
            employeeRecords.forEach(record => {
                const dateKey = new Date(record.check_in).toDateString();
                if (!recordsByDate[dateKey]) {
                    recordsByDate[dateKey] = [];
                }
                recordsByDate[dateKey].push(record);
            });

            const contentDiv = document.getElementById('employeeDetailContent');
            if (!contentDiv) return;
            
            if (Object.keys(recordsByDate).length === 0) {
                contentDiv.innerHTML = '<div class="text-center py-8 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng trong th√°ng n√†y</div>';
                return;
            }

            contentDiv.innerHTML = Object.keys(recordsByDate).map(dateKey => {
                const dayRecords = recordsByDate[dateKey];
                const totalHours = dayRecords.reduce((total, record) => 
                    total + calculateWorkingHours(record.check_in, record.check_out), 0
                );
                const dailySalary = totalHours * employee.hourly_rate;

                return `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-gray-800">
                                ${new Date(dateKey).toLocaleDateString('vi-VN')}
                            </span>
                            <div class="text-right">
                                <div class="text-blue-600 font-medium">${totalHours.toFixed(1)}h</div>
                                <div class="text-green-600 text-sm font-medium">${Math.round(dailySalary).toLocaleString('vi-VN')} ‚Ç´</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${dayRecords.map((record, index) => {
                                const sessionHours = calculateWorkingHours(record.check_in, record.check_out);
                                const sessionSalary = sessionHours * employee.hourly_rate;
                                
                                return `
                                    <div class="text-sm bg-white p-3 rounded border-l-4 ${record.check_out ? 'border-green-400' : 'border-yellow-400'}">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium text-gray-700">Ca ${index + 1}</span>
                                            <div class="flex gap-2">
                                                ${record.check_out ? 
                                                    `<input 
                                                        type="number" 
                                                        step="0.1" 
                                                        value="${sessionHours.toFixed(1)}" 
                                                        class="w-20 px-2 py-1 border border-gray-300 rounded text-xs"
                                                        onchange="updateRecordHours(${record.id}, this.value)"
                                                    />
                                                    <span class="text-xs text-gray-500">h</span>` :
                                                    `<span class="text-yellow-600 font-medium">ƒêang trong ca</span>`
                                                }
                                                <button 
                                                    onclick="deleteRecord(${record.id})" 
                                                    class="text-red-500 hover:text-red-700 text-xs px-2 py-1 hover:bg-red-50 rounded"
                                                    title="X√≥a ca n√†y"
                                                >
                                                    X√≥a
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-gray-600 text-xs">
                                            <span>B·∫Øt ƒë·∫ßu: ${new Date(record.check_in).toLocaleTimeString('vi-VN')}</span>
                                            ${record.check_out ? 
                                                `<span class="ml-4">K·∫øt th√∫c: ${new Date(record.check_out).toLocaleTimeString('vi-VN')}</span>` : 
                                                '<span class="ml-4 text-yellow-600">(Ch∆∞a k·∫øt th√∫c)</span>'
                                            }
                                        </div>
                                        ${record.check_out ? 
                                            `<div class="text-green-600 text-xs mt-1">L∆∞∆°ng ca: ${Math.round(sessionSalary).toLocaleString('vi-VN')} ‚Ç´</div>` : ''
                                        }
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateRecordHours(recordId, newHours) {
            if (!newHours || isNaN(newHours) || newHours < 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë gi·ªù h·ª£p l·ªá!');
                loadEmployeeDetail();
                return;
            }

            try {
                updateSyncStatus('syncing');
                const record = attendanceRecords.find(r => r.id === recordId);
                if (!record || !record.check_out) {
                    alert('Kh√¥ng th·ªÉ s·ª≠a ca ƒëang l√†m vi·ªác!');
                    updateSyncStatus('synced');
                    return;
                }

                const checkInTime = new Date(record.check_in);
                const newCheckOutTime = new Date(checkInTime.getTime() + (parseFloat(newHours) * 60 * 60 * 1000));

                const response = await cloudAPI.updateAttendanceRecord(recordId, {
                    check_out: newCheckOutTime.toISOString()
                });

                if (response.success) {
                    const index = attendanceRecords.findIndex(r => r.id === recordId);
                    if (index !== -1) {
                        attendanceRecords[index].check_out = newCheckOutTime.toISOString();
                    }
                    loadEmployeeDetail();
                    renderEmployeeTable();
                    updateSyncStatus('synced');
                } else {
                    updateSyncStatus('error');
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!');
                }
            } catch (error) {
                console.error('Update record failed:', error);
                updateSyncStatus('error');
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!');
            }
        }

        async function deleteRecord(recordId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ca l√†m vi·ªác n√†y?')) {
                return;
            }

            try {
                updateSyncStatus('syncing');
                const response = await cloudAPI.deleteAttendanceRecord(recordId);
                
                if (response.success) {
                    attendanceRecords = attendanceRecords.filter(record => record.id !== recordId);
                    loadEmployeeDetail();
                    renderEmployeeTable();
                    updateSyncStatus('synced');
                } else {
                    updateSyncStatus('error');
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a!');
                }
            } catch (error) {
                console.error('Delete record failed:', error);
                updateSyncStatus('error');
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a!');
            }
        }

        // Event listeners
        function addEventListeners() {
            if (eventListenersAdded) return;
            
            const logoutBtn = document.getElementById('logoutButton');
            const checkinBtn = document.getElementById('checkinButton');
            const checkoutBtn = document.getElementById('checkoutButton');
            const exportBtn = document.getElementById('exportButton');

            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (checkinBtn) checkinBtn.addEventListener('click', handleCheckin);
            if (checkoutBtn) checkoutBtn.addEventListener('click', handleCheckout);
            if (exportBtn) exportBtn.addEventListener('click', exportToExcel);

            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const adminMonthSelect = document.getElementById('adminMonthSelect');
            const adminYearSelect = document.getElementById('adminYearSelect');

            if (monthSelect) {
                monthSelect.addEventListener('change', (e) => {
                    selectedMonth = parseInt(e.target.value);
                    if (currentUser && currentUser.role === 'employee') {
                        renderHistory();
                        updateEmployeeSalaryInfo();
                    }
                });
            }

            if (yearSelect) {
                yearSelect.addEventListener('change', (e) => {
                    selectedYear = parseInt(e.target.value);
                    if (currentUser && currentUser.role === 'employee') {
                        renderHistory();
                        updateEmployeeSalaryInfo();
                    }
                });
            }

            if (adminMonthSelect) {
                adminMonthSelect.addEventListener('change', (e) => {
                    selectedMonth = parseInt(e.target.value);
                    if (currentUser && currentUser.role === 'admin') {
                        renderEmployeeTable();
                    }
                });
            }

            if (adminYearSelect) {
                adminYearSelect.addEventListener('change', (e) => {
                    selectedYear = parseInt(e.target.value);
                    if (currentUser && currentUser.role === 'admin') {
                        renderEmployeeTable();
                    }
                });
            }

            eventListenersAdded = true;
        }

        // Start the app
        setInterval(updateTime, 1000);
        updateTime();
        initializeApp();
    </script>

    <!-- 
    ============================================
    üî• H∆Ø·ªöNG D·∫™N SETUP DATABASE TH·∫¨T (Supabase)
    ============================================
    
    üéØ B∆Ø·ªöC 1: T·∫°o t√†i kho·∫£n Supabase
    - Truy c·∫≠p: https://supabase.com
    - ƒêƒÉng k√Ω mi·ªÖn ph√≠
    - T·∫°o project m·ªõi: "vta-attendance"
    
    üéØ B∆Ø·ªöC 2: L·∫•y config
    - V√†o Settings ‚Üí API  
    - Copy "Project URL" v√† "anon public" key
    - Thay v√†o 2 d√≤ng ƒë·∫ßu JavaScript ·ªü tr√™n
    
    üéØ B∆Ø·ªöC 3: T·∫°o b·∫£ng
    - V√†o SQL Editor
    - Paste v√† ch·∫°y script sau:

    -- T·∫°o b·∫£ng employees
    CREATE TABLE employees (
        id SERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        username VARCHAR(100) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        role VARCHAR(50) DEFAULT 'employee',
        hourly_rate DECIMAL(10,2) DEFAULT 0,
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- T·∫°o b·∫£ng attendance_records  
    CREATE TABLE attendance_records (
        id SERIAL PRIMARY KEY,
        employee_id INTEGER REFERENCES employees(id) ON DELETE CASCADE,
        employee_name VARCHAR(255) NOT NULL,
        check_in TIMESTAMP NOT NULL,
        check_out TIMESTAMP NULL,
        date DATE NOT NULL,
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- Th√™m d·ªØ li·ªáu demo
    INSERT INTO employees (name, username, password, role, hourly_rate) VALUES
    ('Nguy·ªÖn VƒÉn A', 'admin', 'admin', 'admin', 100000),
    ('Tr·∫ßn Th·ªã B', 'nhanvien1', '123', 'employee', 50000),
    ('L√™ VƒÉn C', 'nhanvien2', '123', 'employee', 45000),
    ('Ph·∫°m Th·ªã D', 'nhanvien3', '123', 'employee', 48000);

    üéØ B∆Ø·ªöC 4: Deploy
    - Save file HTML n√†y
    - Deploy l√™n Vercel/Netlify  
    - Chia s·∫ª link cho t·∫•t c·∫£ nh√¢n vi√™n
    
    üéØ K·∫æT QU·∫¢:
    ‚úÖ T·∫•t c·∫£ thi·∫øt b·ªã truy c·∫≠p c√πng 1 link
    ‚úÖ D·ªØ li·ªáu ƒë·ªìng b·ªô th·ªùi gian th·ª±c
    ‚úÖ Kh√¥ng gi·ªõi h·∫°n s·ªë thi·∫øt b·ªã
    ‚úÖ Admin qu·∫£n l√Ω t·ª´ xa
    ‚úÖ Mi·ªÖn ph√≠ cho qu√°n nh·ªè (ƒë·∫øn 500MB)
    
    üìû C·∫ßn h·ªó tr·ª£: Comment l·∫°i, t√¥i s·∫Ω h∆∞·ªõng d·∫´n chi ti·∫øt!
    -->
</body>
</html>