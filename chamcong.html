<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTA-FE & TEA - H·ªá Th·ªëng Ch·∫•m C√¥ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-small {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen bg-gradient-to-br from-blue-50 to-white flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ server...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-blue-50 to-white flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md border border-blue-100">
            <div class="text-center mb-8">
                <div class="bg-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="text-white w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">VTA-FE & TEA</h1>
                <p class="text-gray-600">H·ªá Th·ªëng Ch·∫•m C√¥ng</p>
                
                <div id="loginSyncStatus" class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-green-100 text-green-700">
                    <span>ƒê√£ ƒë·ªìng b·ªô</span>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input
                        type="text"
                        id="username"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                        placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                    <input
                        type="password"
                        id="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                    />
                </div>
                
                <button
                    id="loginButton"
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2"
                >
                    ƒêƒÉng Nh·∫≠p
                </button>
                
                <div class="text-sm text-gray-500 text-center mt-4">
                    <p><strong>Demo accounts:</strong></p>
                    <p>Admin: admin / admin</p>
                    <p>NV: nhanvien1 / 123</p>
                    <p class="mt-2 text-xs text-blue-600">üíæ D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n server</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="min-h-screen bg-gradient-to-br from-blue-50 to-white hidden">
        <!-- Header -->
        <div class="bg-white shadow-lg border-b border-blue-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500 w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="text-white w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">VTA-FE & TEA</h1>
                            <p class="text-sm text-gray-600">H·ªá Th·ªëng Ch·∫•m C√¥ng</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div id="mainSyncStatus" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-700">
                            <span>ƒê√£ ƒë·ªìng b·ªô</span>
                        </div>
                        
                        <div class="text-right">
                            <p class="font-medium text-gray-800" id="currentUserName">Ng∆∞·ªùi d√πng</p>
                            <p class="text-sm text-blue-600 capitalize" id="currentUserRole">employee</p>
                        </div>
                        <button
                            id="logoutButton"
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2"
                        >
                            ƒêƒÉng Xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Time Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-blue-100">
                <div class="text-center">
                    <div class="text-4xl font-bold text-blue-600 mb-2" id="currentTime">
                        00:00:00
                    </div>
                    <div class="text-lg text-gray-600" id="currentDate">
                        H√¥m nay
                    </div>
                </div>
            </div>

            <!-- Employee Dashboard -->
            <div id="employeeDashboard" class="space-y-8 hidden">
                <!-- Salary Summary Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd" />
                        </svg>
                        T·ªïng L∆∞∆°ng Th√°ng <span id="currentMonthYear" class="text-blue-600"></span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">L∆∞∆°ng/Gi·ªù</p>
                            <p class="text-2xl font-bold text-blue-600" id="hourlyRateDisplay">0 ‚Ç´</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">T·ªïng Gi·ªù L√†m</p>
                            <p class="text-2xl font-bold text-green-600" id="totalHoursDisplay">0h</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">T·ªïng L∆∞∆°ng</p>
                            <p class="text-2xl font-bold text-yellow-600" id="totalSalaryDisplay">0 ‚Ç´</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">
                            üí° <strong>H·ªá th·ªëng ca l√†m vi·ªác:</strong> M·ªói l·∫ßn "V√†o Ca M·ªõi" t·∫°o m·ªôt ca ri√™ng bi·ªát. "K·∫øt Th√∫c Ca" ƒë·ªÉ ho√†n th√†nh ca hi·ªán t·∫°i. T√≠nh l∆∞∆°ng ch√≠nh x√°c theo th·ªùi gian th·ª±c.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Attendance Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            Ch·∫•m C√¥ng
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="text-center">
                                <div id="workingStatus" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
                                    Ch∆∞a ch·∫•m c√¥ng
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <button
                                    id="checkinButton"
                                    class="w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-green-500 text-white hover:bg-green-600"
                                >
                                    V√†o Ca M·ªõi
                                </button>
                                
                                <button
                                    id="checkoutButton"
                                    class="w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-red-500 text-white hover:bg-red-600"
                                    disabled
                                >
                                    K·∫øt Th√∫c Ca
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- History Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd" />
                            </svg>
                            L·ªãch S·ª≠ L√†m Vi·ªác
                        </h2>
                        
                        <div class="mb-4 flex gap-2">
                            <select
                                id="monthSelect"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            >
                                <option value="1">Th√°ng 1</option>
                                <option value="2">Th√°ng 2</option>
                                <option value="3">Th√°ng 3</option>
                                <option value="4">Th√°ng 4</option>
                                <option value="5">Th√°ng 5</option>
                                <option value="6">Th√°ng 6</option>
                                <option value="7">Th√°ng 7</option>
                                <option value="8">Th√°ng 8</option>
                                <option value="9">Th√°ng 9</option>
                                <option value="10">Th√°ng 10</option>
                                <option value="11">Th√°ng 11</option>
                                <option value="12">Th√°ng 12</option>
                            </select>
                            
                            <select
                                id="yearSelect"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            >
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>

                        <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng trong th√°ng n√†y
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="space-y-8 hidden">
                <!-- Controls -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="text-blue-500 w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                </svg>
                                Qu·∫£n L√Ω Nh√¢n Vi√™n
                            </h2>
                            
                            <div class="flex gap-2">
                                <select
                                    id="adminMonthSelect"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                >
                                    <option value="1">Th√°ng 1</option>
                                    <option value="2">Th√°ng 2</option>
                                    <option value="3">Th√°ng 3</option>
                                    <option value="4">Th√°ng 4</option>
                                    <option value="5">Th√°ng 5</option>
                                    <option value="6">Th√°ng 6</option>
                                    <option value="7">Th√°ng 7</option>
                                    <option value="8">Th√°ng 8</option>
                                    <option value="9">Th√°ng 9</option>
                                    <option value="10">Th√°ng 10</option>
                                    <option value="11">Th√°ng 11</option>
                                    <option value="12">Th√°ng 12</option>
                                </select>
                                
                                <select
                                    id="adminYearSelect"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                >
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </div>
                        
                        <button
                            id="exportButton"
                            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2"
                        >
                            Xu·∫•t Excel
                        </button>
                    </div>
                </div>

                <!-- Employee Table -->
                <div class="bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Nh√¢n Vi√™n</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">L∆∞∆°ng/Gi·ªù</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Gi·ªù L√†m/Th√°ng</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">L∆∞∆°ng Th·ª±c Nh·∫≠n</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let employees = [];
        let attendanceRecords = [];
        let isWorking = false;
        let syncStatus = 'synced';
        let selectedMonth = new Date().getMonth() + 1;
        let selectedYear = new Date().getFullYear();
        let editingEmployee = null;

        // Mock API v·ªõi l∆∞∆°ng theo gi·ªù
        const mockAPI = {
            delay: (ms = 500) => new Promise(resolve => setTimeout(resolve, ms)),
            
            db: {
                employees: [
                    { id: 1, name: 'Nguy·ªÖn VƒÉn A', username: 'admin', password: 'admin', role: 'admin', hourlyRate: 100000 },
                    { id: 2, name: 'Tr·∫ßn Th·ªã B', username: 'nhanvien1', password: '123', role: 'employee', hourlyRate: 50000 },
                    { id: 3, name: 'L√™ VƒÉn C', username: 'nhanvien2', password: '123', role: 'employee', hourlyRate: 45000 }
                ],
                attendanceRecords: []
            },

            async getEmployees() {
                await this.delay();
                return { success: true, data: this.db.employees };
            },

            async getAttendanceRecords() {
                await this.delay();
                return { success: true, data: this.db.attendanceRecords };
            },

            async updateEmployee(id, data) {
                await this.delay();
                const index = this.db.employees.findIndex(emp => emp.id === id);
                if (index !== -1) {
                    this.db.employees[index] = { ...this.db.employees[index], ...data };
                    return { success: true, data: this.db.employees[index] };
                }
                return { success: false, error: 'Employee not found' };
            },

            async deleteEmployee(id) {
                await this.delay();
                this.db.employees = this.db.employees.filter(emp => emp.id !== id);
                this.db.attendanceRecords = this.db.attendanceRecords.filter(record => record.employeeId !== id);
                return { success: true };
            },

            async addAttendanceRecord(record) {
                await this.delay();
                const newRecord = { ...record, id: Date.now() };
                this.db.attendanceRecords.push(newRecord);
                return { success: true, data: newRecord };
            },

            async updateAttendanceRecord(id, data) {
                await this.delay();
                const index = this.db.attendanceRecords.findIndex(record => record.id === id);
                if (index !== -1) {
                    this.db.attendanceRecords[index] = { ...this.db.attendanceRecords[index], ...data };
                    return { success: true, data: this.db.attendanceRecords[index] };
                }
                return { success: false, error: 'Record not found' };
            }
        };

        // Helper functions
        function updateSyncStatus(status) {
            syncStatus = status;
            const statusElements = ['loginSyncStatus', 'mainSyncStatus'];
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    let className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm ';
                    let content = '';
                    
                    if (status === 'synced') {
                        className += 'bg-green-100 text-green-700';
                        content = '<span>ƒê√£ ƒë·ªìng b·ªô</span>';
                    } else if (status === 'syncing') {
                        className += 'bg-yellow-100 text-yellow-700';
                        content = '<div class="spinner-small"></div><span>ƒêang ƒë·ªìng b·ªô...</span>';
                    } else if (status === 'error') {
                        className += 'bg-red-100 text-red-700';
                        content = '<span>L·ªói k·∫øt n·ªëi</span>';
                    }
                    
                    element.className = className;
                    element.innerHTML = content;
                }
            });
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function calculateWorkingHours(checkIn, checkOut) {
            if (!checkOut) return 0;
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            const hours = (end - start) / (1000 * 60 * 60);
            // T√≠nh ch√≠nh x√°c theo ph√∫t, kh√¥ng l√†m tr√≤n
            return hours;
        }

        function getMonthlyRecords(employeeId) {
            return attendanceRecords.filter(record => {
                const recordDate = new Date(record.checkIn);
                return record.employeeId === employeeId && 
                       recordDate.getMonth() + 1 === selectedMonth && 
                       recordDate.getFullYear() === selectedYear;
            });
        }

        function calculateMonthlySalary(employee) {
            const monthlyRecords = getMonthlyRecords(employee.id);
            const totalHours = monthlyRecords.reduce((total, record) => {
                return total + calculateWorkingHours(record.checkIn, record.checkOut);
            }, 0);
            return Math.round(totalHours * employee.hourlyRate);
        }

        function updateEmployeeSalaryInfo() {
            if (currentUser && currentUser.role === 'employee') {
                const monthlyRecords = getMonthlyRecords(currentUser.id);
                const totalHours = monthlyRecords.reduce((total, record) => {
                    return total + calculateWorkingHours(record.checkIn, record.checkOut);
                }, 0);
                const totalSalary = totalHours * currentUser.hourlyRate;
                
                // Update display elements
                document.getElementById('currentMonthYear').textContent = `${selectedMonth}/${selectedYear}`;
                document.getElementById('hourlyRateDisplay').textContent = currentUser.hourlyRate.toLocaleString('vi-VN') + ' ‚Ç´';
                document.getElementById('totalHoursDisplay').textContent = totalHours.toFixed(1) + 'h';
                document.getElementById('totalSalaryDisplay').textContent = Math.round(totalSalary).toLocaleString('vi-VN') + ' ‚Ç´';
            }
        }

        // Initialize app
        async function initializeApp() {
            try {
                updateSyncStatus('syncing');
                
                const [employeesResponse, recordsResponse] = await Promise.all([
                    mockAPI.getEmployees(),
                    mockAPI.getAttendanceRecords()
                ]);

                if (employeesResponse.success) {
                    employees = employeesResponse.data;
                }
                
                if (recordsResponse.success) {
                    attendanceRecords = recordsResponse.data;
                }

                updateSyncStatus('synced');
                showLoginScreen();
            } catch (error) {
                console.error('Failed to load data:', error);
                updateSyncStatus('error');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Set current month/year
            document.getElementById('monthSelect').value = selectedMonth;
            document.getElementById('yearSelect').value = selectedYear;
            document.getElementById('adminMonthSelect').value = selectedMonth;
            document.getElementById('adminYearSelect').value = selectedYear;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role;
            
            if (currentUser.role === 'employee') {
                document.getElementById('employeeDashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                updateEmployeeStatus();
                renderHistory();
                updateEmployeeSalaryInfo();
            } else {
                document.getElementById('employeeDashboard').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                renderEmployeeTable();
            }
        }

        function updateEmployeeStatus() {
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                record.employeeId === currentUser.id && 
                new Date(record.checkIn).toDateString() === today
            );
            
            // T√¨m ca ƒëang l√†m vi·ªác (ch∆∞a k·∫øt th√∫c)
            const activeSession = todayRecords.find(record => !record.checkOut);
            isWorking = !!activeSession;
            
            const statusElement = document.getElementById('workingStatus');
            const checkinButton = document.getElementById('checkinButton');
            const checkoutButton = document.getElementById('checkoutButton');
            
            if (isWorking) {
                const startTime = new Date(activeSession.checkIn).toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                statusElement.textContent = `ƒêang trong ca (b·∫Øt ƒë·∫ßu ${startTime})`;
                statusElement.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-700';
                
                checkinButton.disabled = true;
                checkinButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-gray-100 text-gray-400 cursor-not-allowed';
                checkinButton.textContent = 'ƒêang Trong Ca';
                
                checkoutButton.disabled = false;
                checkoutButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-red-500 text-white hover:bg-red-600';
                checkoutButton.textContent = 'K·∫øt Th√∫c Ca';
            } else {
                const completedSessions = todayRecords.filter(record => record.checkOut).length;
                const totalHoursToday = todayRecords.reduce((total, record) => 
                    total + calculateWorkingHours(record.checkIn, record.checkOut), 0
                );
                
                if (completedSessions > 0) {
                    statusElement.textContent = `ƒê√£ ho√†n th√†nh ${completedSessions} ca (${totalHoursToday.toFixed(1)}h)`;
                } else {
                    statusElement.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu ca l√†m vi·ªác h√¥m nay';
                }
                statusElement.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-700';
                
                checkinButton.disabled = false;
                checkinButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-green-500 text-white hover:bg-green-600';
                checkinButton.textContent = completedSessions > 0 ? 'V√†o Ca M·ªõi' : 'B·∫Øt ƒê·∫ßu Ca';
                
                checkoutButton.disabled = true;
                checkoutButton.className = 'w-full py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors bg-gray-100 text-gray-400 cursor-not-allowed';
                checkoutButton.textContent = 'K·∫øt Th√∫c Ca';
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const records = getMonthlyRecords(currentUser.id);
            
            if (records.length === 0) {
                historyList.innerHTML = '<div class="text-center py-8 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng trong th√°ng n√†y</div>';
            } else {
                // Nh√≥m records theo ng√†y
                const recordsByDate = {};
                records.forEach(record => {
                    const dateKey = new Date(record.checkIn).toDateString();
                    if (!recordsByDate[dateKey]) {
                        recordsByDate[dateKey] = [];
                    }
                    recordsByDate[dateKey].push(record);
                });

                historyList.innerHTML = Object.keys(recordsByDate).map(dateKey => {
                    const dayRecords = recordsByDate[dateKey];
                    const totalHours = dayRecords.reduce((total, record) => 
                        total + calculateWorkingHours(record.checkIn, record.checkOut), 0
                    );
                    const dailySalary = totalHours * currentUser.hourlyRate;

                    return `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-800">
                                    ${new Date(dateKey).toLocaleDateString('vi-VN')}
                                </span>
                                <div class="text-right">
                                    <div class="text-blue-600 font-medium">${totalHours.toFixed(1)}h</div>
                                    <div class="text-green-600 text-sm font-medium">${Math.round(dailySalary).toLocaleString('vi-VN')} ‚Ç´</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                ${dayRecords.map((record, index) => {
                                    const sessionHours = calculateWorkingHours(record.checkIn, record.checkOut);
                                    const sessionSalary = sessionHours * currentUser.hourlyRate;
                                    
                                    return `
                                        <div class="text-sm bg-white p-3 rounded border-l-4 ${record.checkOut ? 'border-green-400' : 'border-yellow-400'}">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-medium text-gray-700">Ca ${index + 1}</span>
                                                ${record.checkOut ? 
                                                    `<span class="text-green-600 font-medium">${sessionHours.toFixed(1)}h - ${Math.round(sessionSalary).toLocaleString('vi-VN')} ‚Ç´</span>` :
                                                    `<span class="text-yellow-600 font-medium">ƒêang trong ca</span>`
                                                }
                                            </div>
                                            <div class="text-gray-600">
                                                <span>B·∫Øt ƒë·∫ßu: ${new Date(record.checkIn).toLocaleTimeString('vi-VN')}</span>
                                                ${record.checkOut ? 
                                                    `<span class="ml-4">K·∫øt th√∫c: ${new Date(record.checkOut).toLocaleTimeString('vi-VN')}</span>` : 
                                                    '<span class="ml-4 text-yellow-600">(Ch∆∞a k·∫øt th√∫c)</span>'
                                                }
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update salary info after rendering history
            updateEmployeeSalaryInfo();
        }

        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            const employeeList = employees.filter(emp => emp.role === 'employee');
            
            tbody.innerHTML = employeeList.map(employee => {
                const monthlyHours = getMonthlyRecords(employee.id).reduce((total, record) => 
                    total + calculateWorkingHours(record.checkIn, record.checkOut), 0
                );
                
                const monthlySalary = calculateMonthlySalary(employee);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                                    <svg class="text-blue-600 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${employee.name}</p>
                                    <p class="text-sm text-gray-500">ID: ${employee.id}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${editingEmployee === employee.id ? 
                                `<div class="flex gap-2">
                                    <input
                                        type="number"
                                        value="${employee.hourlyRate}"
                                        class="w-32 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        onkeypress="handleSalaryEdit(event, ${employee.id})"
                                    />
                                    <button onclick="cancelEdit()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                                </div>` :
                                `<span class="text-gray-800 font-medium">${employee.hourlyRate.toLocaleString('vi-VN')} ‚Ç´/h</span>`
                            }
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-800">${monthlyHours.toFixed(1)}h</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-green-600 font-bold">${monthlySalary.toLocaleString('vi-VN')} ‚Ç´</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button
                                    onclick="editEmployee(${employee.id})"
                                    class="text-blue-500 hover:text-blue-700 p-2 hover:bg-blue-50 rounded-lg transition-colors ${syncStatus === 'syncing' ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${syncStatus === 'syncing' ? 'disabled' : ''}
                                >
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button
                                    onclick="deleteEmployee(${employee.id})"
                                    class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition-colors ${syncStatus === 'syncing' ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${syncStatus === 'syncing' ? 'disabled' : ''}
                                >
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Event handlers
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                updateSyncStatus('syncing');
                await mockAPI.delay(300);
                
                const user = employees.find(emp => 
                    emp.username === username && emp.password === password
                );
                
                if (user) {
                    currentUser = user;
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    updateSyncStatus('synced');
                    showMainApp();
                } else {
                    alert('Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng!');
                    updateSyncStatus('error');
                    setTimeout(() => updateSyncStatus('synced'), 2000);
                }
            } catch (error) {
                console.error('Login failed:', error);
                updateSyncStatus('error');
            }
        }

        function handleLogout() {
            currentUser = null;
            isWorking = false;
            editingEmployee = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        async function handleCheckin() {
            try {
                updateSyncStatus('syncing');
                const now = new Date();
                const newRecord = {
                    employeeId: currentUser.id,
                    employeeName: currentUser.name,
                    checkIn: now.toISOString(),
                    checkOut: null,
                    date: now.toDateString()
                };
                
                const response = await mockAPI.addAttendanceRecord(newRecord);
                
                if (response.success) {
                    attendanceRecords.push(response.data);
                    updateEmployeeStatus();
                    renderHistory();
                    updateSyncStatus('synced');
                }
            } catch (error) {
                console.error('Check-in failed:', error);
                updateSyncStatus('error');
            }
        }

        async function handleCheckout() {
            try {
                updateSyncStatus('syncing');
                const now = new Date();
                
                // T√¨m record ch∆∞a checkout (ƒëang active)
                const recordToUpdate = attendanceRecords.find(record => 
                    record.employeeId === currentUser.id && !record.checkOut
                );

                if (recordToUpdate) {
                    const response = await mockAPI.updateAttendanceRecord(recordToUpdate.id, {
                        checkOut: now.toISOString()
                    });

                    if (response.success) {
                        const index = attendanceRecords.findIndex(r => r.id === recordToUpdate.id);
                        attendanceRecords[index] = response.data;
                        updateEmployeeStatus();
                        renderHistory();
                        updateSyncStatus('synced');
                    }
                }
            } catch (error) {
                console.error('Check-out failed:', error);
                updateSyncStatus('error');
            }
        }

        function editEmployee(employeeId) {
            if (editingEmployee === employeeId) {
                editingEmployee = null;
            } else {
                editingEmployee = employeeId;
            }
            renderEmployeeTable();
        }

        function cancelEdit() {
            editingEmployee = null;
            renderEmployeeTable();
        }

        async function handleSalaryEdit(event, employeeId) {
            if (event.key === 'Enter') {
                const newSalary = event.target.value;
                
                if (!newSalary || isNaN(newSalary)) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá!');
                    return;
                }

                try {
                    updateSyncStatus('syncing');
                    const response = await mockAPI.updateEmployee(employeeId, { 
                        hourlyRate: parseFloat(newSalary) 
                    });
                    
                    if (response.success) {
                        const index = employees.findIndex(emp => emp.id === employeeId);
                        employees[index] = response.data;
                        editingEmployee = null;
                        renderEmployeeTable();
                        updateSyncStatus('synced');
                    }
                } catch (error) {
                    console.error('Update salary failed:', error);
                    updateSyncStatus('error');
                }
            }
        }

        async function deleteEmployee(employeeId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?')) {
                return;
            }

            try {
                updateSyncStatus('syncing');
                const response = await mockAPI.deleteEmployee(employeeId);
                
                if (response.success) {
                    employees = employees.filter(emp => emp.id !== employeeId);
                    attendanceRecords = attendanceRecords.filter(record => record.employeeId !== employeeId);
                    renderEmployeeTable();
                    updateSyncStatus('synced');
                }
            } catch (error) {
                console.error('Delete employee failed:', error);
                updateSyncStatus('error');
            }
        }

        function exportToExcel() {
            const data = employees.filter(emp => emp.role === 'employee').map(emp => {
                const monthlyHours = getMonthlyRecords(emp.id).reduce((total, record) => 
                    total + calculateWorkingHours(record.checkIn, record.checkOut), 0
                );
                const monthlySalary = calculateMonthlySalary(emp);
                
                return {
                    'H·ªç T√™n': emp.name,
                    'L∆∞∆°ng/Gi·ªù': emp.hourlyRate.toLocaleString('vi-VN'),
                    'Gi·ªù L√†m Th√°ng': monthlyHours.toFixed(1),
                    'L∆∞∆°ng Th·ª±c Nh·∫≠n': monthlySalary.toLocaleString('vi-VN')
                };
            });
            
            const csvContent = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bang-luong-${selectedMonth}-${selectedYear}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('logoutButton').addEventListener('click', handleLogout);
        document.getElementById('checkinButton').addEventListener('click', handleCheckin);
        document.getElementById('checkoutButton').addEventListener('click', handleCheckout);
        document.getElementById('exportButton').addEventListener('click', exportToExcel);

        // Month/Year change handlers
        document.getElementById('monthSelect').addEventListener('change', (e) => {
            selectedMonth = parseInt(e.target.value);
            renderHistory();
            if (currentUser && currentUser.role === 'employee') {
                updateEmployeeSalaryInfo();
            }
        });

        document.getElementById('yearSelect').addEventListener('change', (e) => {
            selectedYear = parseInt(e.target.value);
            renderHistory();
            if (currentUser && currentUser.role === 'employee') {
                updateEmployeeSalaryInfo();
            }
        });

        document.getElementById('adminMonthSelect').addEventListener('change', (e) => {
            selectedMonth = parseInt(e.target.value);
            renderEmployeeTable();
        });

        document.getElementById('adminYearSelect').addEventListener('change', (e) => {
            selectedYear = parseInt(e.target.value);
            renderEmployeeTable();
        });

        // Enter key login
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        // Start the app
        setInterval(updateTime, 1000);
        updateTime();
        initializeApp();
    </script>
</body>
</html>